/*
 * HW-201 IR PROXIMITY SENSOR
 * AUTO CONNECT / DISCONNECT
 * 1s STATUS MONITOR + EVENT LOG
 */

#define IR_PIN        27
#define LED_BUILTIN    2

// Timing
const unsigned long READ_INTERVAL_MS   = 20;
const unsigned long DEBOUNCE_MS        = 40;
const unsigned long HEALTH_TIMEOUT_MS  = 2000;
const unsigned long MONITOR_INTERVAL  = 1000;

// State
bool lastStableState = false;
bool sensorConnected = false;
bool lastRawReading  = false;

unsigned long lastChangeTime      = 0;
unsigned long lastValidSignalTime = 0;
unsigned long lastMonitorTime     = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   HW-201 IR SENSOR (LIVE MONITOR)    â•‘");
  Serial.println("â•‘   LED ON : OBJECT DETECTED (~3cm)    â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  pinMode(IR_PIN, INPUT);      // No pullups
  pinMode(LED_BUILTIN, OUTPUT);
  digitalWrite(LED_BUILTIN, LOW);

  Serial.println("â†’ Monitoring sensor...");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
}

bool readStableIR() {
  bool raw = !digitalRead(IR_PIN);  // ACTIVE LOW

  if (raw != lastRawReading) {
    lastChangeTime = millis();
    lastRawReading = raw;
  }

  if (millis() - lastChangeTime > DEBOUNCE_MS) {
    lastValidSignalTime = millis();
    return raw;
  }

  return lastStableState;
}

void loop() {
  bool detected = readStableIR();

  // -------- SENSOR HEALTH --------
  if (!sensorConnected && millis() - lastValidSignalTime < HEALTH_TIMEOUT_MS) {
    sensorConnected = true;
    Serial.println("âœ“ Sensor connected");
  }

  if (sensorConnected && millis() - lastValidSignalTime > HEALTH_TIMEOUT_MS) {
    sensorConnected = false;
    Serial.println("\nâš  SENSOR DISCONNECTED");
    digitalWrite(LED_BUILTIN, LOW);
  }

  // -------- STATE CHANGE EVENT --------
  if (sensorConnected && detected != lastStableState) {
    Serial.print("EVENT â†’ ");

    if (detected) {
      Serial.println("ðŸ”´ DETECTED");
      digitalWrite(LED_BUILTIN, HIGH);
    } else {
      Serial.println("âšª CLEAR");
      digitalWrite(LED_BUILTIN, LOW);
    }

    lastStableState = detected;
  }

  // -------- 1 SECOND MONITOR --------
  if (millis() - lastMonitorTime >= MONITOR_INTERVAL) {
    lastMonitorTime = millis();

    Serial.print("STATUS | Sensor: ");
    Serial.print(sensorConnected ? "OK" : "LOST");
    Serial.print(" | IR: ");
    Serial.print(detected ? "DETECTED" : "CLEAR");
    Serial.print(" | LED: ");
    Serial.println(digitalRead(LED_BUILTIN) ? "ON" : "OFF");
  }

  delay(READ_INTERVAL_MS);
}
